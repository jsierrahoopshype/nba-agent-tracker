"""Fast Player Name Matching - Optimized for speed"""

import re
from nba_players import NBA_PLAYERS

# Build lookup structures once at import time
FULL_NAMES = set(p.lower() for p in NBA_PLAYERS)
FIRST_NAMES = {}
LAST_NAMES = {}

for player in NBA_PLAYERS:
    parts = player.split()
    if len(parts) >= 2:
        first, last = parts[0].lower(), parts[-1].lower()
        if last not in LAST_NAMES:
            LAST_NAMES[last] = []
        LAST_NAMES[last].append(player)

# Unique last names (only one player has this last name)
UNIQUE_LAST_NAMES = {k: v[0] for k, v in LAST_NAMES.items() if len(v) == 1}

# Common words that should NOT match even if they're unique last names
EXCLUDED_WORDS = {
    "post", "love", "smart", "holiday", "green", "brown", "white", "black",
    "gray", "king", "young", "long", "little", "best", "hart", "wade",
    "rose", "bridges", "wall", "hill", "rice", "prince", "mann", "day",
    "wells", "reed", "waters", "brooks", "banks", "bell", "ford", "lane",
    "grant", "stone", "wood", "wolf", "fox", "dean", "ross", "terry",
    "craig", "cole", "huff", "cook", "monk", "dunn", "bates", "temple",
    "joe", "ben", "sam", "tim", "dan", "tom", "john", "will", "max",
    "cam", "tre", "pat", "drew", "alex", "nick", "gary", "josh", "mike",
    "chris", "kyle", "ryan", "tyler", "jordan", "isaiah", "marcus", "jalen",
    "boston", "houston", "phoenix", "orlando", "washington", "cleveland",
    "cooper", "flagg",  # Cooper Flagg / Sharife Cooper conflict
    "paul", "george", "pg",  # Chris Paul / Paul George conflict
    "alexander",  # Shai Gilgeous-Alexander / Trey Alexander conflict
    "anthony",  # Cole Anthony / Anthony Edwards / Anthony Davis conflict
}

# Remove excluded words from unique last names
for word in EXCLUDED_WORDS:
    UNIQUE_LAST_NAMES.pop(word, None)

# Nicknames mapping - only use distinctive nicknames, not first names
NICKNAMES = {
    "lebron": "LeBron James",
    "steph": "Stephen Curry",
    "giannis": "Giannis Antetokounmpo",
    "jokic": "Nikola Jokic",
    "embiid": "Joel Embiid",
    "kd": "Kevin Durant",
    "ad": "Anthony Davis",
    "cp3": "Chris Paul",
    "trae": "Trae Young",
    "lamelo": "LaMelo Ball",
    "zion": "Zion Williamson",
    "wemby": "Victor Wembanyama",
    "wembanyama": "Victor Wembanyama",
    "sga": "Shai Gilgeous-Alexander",
    "shai": "Shai Gilgeous-Alexander",
    "gilgeous": "Shai Gilgeous-Alexander",
    "ant": "Anthony Edwards",
    "kat": "Karl-Anthony Towns",
    "dame": "Damian Lillard",
    "kyrie": "Kyrie Irving",
    "booker": "Devin Booker",
    "tatum": "Jayson Tatum",
    "harden": "James Harden",
    "westbrook": "Russell Westbrook",
    "sabonis": "Domantas Sabonis",
    "mobley": "Evan Mobley",
    "cade": "Cade Cunningham",
    "paolo": "Paolo Banchero",
    "franz": "Franz Wagner",
    "scottie": "Scottie Barnes",
    "brunson": "Jalen Brunson",
    "flagg": "Cooper Flagg",
    "maxey": "Tyrese Maxey",
    "halliburton": "Tyrese Haliburton",
    "haliburton": "Tyrese Haliburton",
    "garland": "Darius Garland",
    "dejounte": "Dejounte Murray",
    "bam": "Bam Adebayo",
    "herro": "Tyler Herro",
    "jimmy": "Jimmy Butler",
    "kawhi": "Kawhi Leonard",
}

# Precompile word pattern - include numbers for nicknames like cp3
WORD_PATTERN = re.compile(r"[a-zA-Z0-9']+")


def find_player_mentions(text):
    """Fast player mention detection."""
    if not text:
        return {}
    
    found = {}
    text_lower = text.lower()
    words = WORD_PATTERN.findall(text_lower)
    word_set = set(words)
    
    # Check nicknames (fast set lookup)
    for nick, player in NICKNAMES.items():
        if nick in word_set:
            found[player] = [nick]
    
    # Check full names by looking at word pairs
    for i in range(len(words) - 1):
        full_name = words[i] + " " + words[i + 1]
        if full_name in FULL_NAMES:
            # Find proper case version
            for player in NBA_PLAYERS:
                if player.lower() == full_name:
                    if player not in found:
                        found[player] = []
                    found[player].append(full_name)
                    break
    
    # Check unique last names (but not excluded common words)
    for word in word_set:
        if word in UNIQUE_LAST_NAMES:
            player = UNIQUE_LAST_NAMES[word]
            if player not in found:
                found[player] = [word]
    
    return found
